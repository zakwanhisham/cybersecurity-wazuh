# Wazuh

## What is Wazuh

Wazuh is a free and open source security platform that unifies XDR and SIEM capabilities.
It protects workloads across on-premises, virtualized, containerized, and cloud-based environments.

Wazuh helps organizations and individuals to protect their data assets against security threats.
It is widely used by thousands of organizations worldwide, from small business to large enterprises.

We will discuss about these three components of wazuh `components`, `architecture`, and common `use cases`.

## Components

There are 4 components in wazuh:

1. Wazuh indexer:
   - Highly scalable, full-text search, and analytics engine
   - **Indexes and stores alerts generated by Wazuh Server**
2. Wazuh Server:
   - Analyzes data received from the agents.
   - Process through decoders and rules, using **_threat intelligence_** to look for well known indicators of compromise.
   - One server can analyze data from hundreds or thousands of agents, and can scale horizontally when set up as a cluster.
   - Used to manage the agents, configure, and upgrade agent remotely.
3. Wazuh dashboard:
   - Web user interface for data visualization and analysis.
   - Include:
     - **security events**
     - **regulatory compliance**
     - **detected vulnerable applications**
     - **file integrity monitoring data**
     - **configuration assessment results**
     - **cloud infrastructure monitoring events**
   - Manage wazuh config and monitor its status
4. Wazuh agents:
   - Installed on endpoints such as:
     - _laptops_
     - _desktops_
     - _server_
     - _cloud instance_
     - _virtual machines_
   - Provide `threat prevention`, `detection`, and `response capabilities`
   - Supported software:
     - **Windows**
     - **MacOS**
     - **Linux**
     - **Solaris**
     - **AIX**
     - **HP-UX**

This diagrams below represents the wazuh components and data flow.

![Wazuh component and data flow](https://firebasestorage.googleapis.com/v0/b/test-agent-nwfy.appspot.com/o/wazuh-components-and-data-flow1.png?alt=media&token=9922c12d-3d8c-4505-beb8-b1d898697f50)

## Wazuh Indexer

- Central component indexes and stores alerts generated by the wazuh server and provides near real-time data search and analytic capabilities.
- Can be configure as a single node or multi node cluster, to provide scalability and high availability.
- Store data in JSON doc format.
- Each doc correlates a set of keys, field names or properties, which can be:
  - `string`
  - `numbers`
  - `booleans`
  - `dates`
  - `arrays of values`
  - `geolocation`
  - `and many more`
- **_What is an index_**:
  - Collection of documents that are related to each other.
- Document stored in wazuh indexer are distributed across different containers know as `shards`
- We can distribute the documents across multiple shards, and distribute those shards across multiple nodes to ensure redundancy.
  - Protect system against hardware failures and increases query capacity as nodes are added to a cluster.

### Four Indices

| Index            | Description                                                                                                                                                                                  |
| ---------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| wazuh-alerts     | Stores alerts generated by the wazuh server. These are created each time an event trips a rule with a high enough priority (can be configure)                                                |
| wazuh-archives   | Stores all events(archive data) received by the wazuh server, don't matter if tripping a rule or not                                                                                         |
| wazuh-monitoring | Stores data related to the wazuh agent status over time. It is used by the web interface to represent when individual agents are or have been `Active`, `Disconnected`, or `Never connected` |
| wazuh-statustics | Stores data related to wazuh aserver performance. It is used by the web interface to represent the performance statistics.                                                                   |

## Wazuh Server

- Analyzes the data received from the agents, triggering alerts when threats or anomalies are detected.
- Used to manage the agents configuration remotely and monitoring.
- Uses threat intelligence source to improve its detection capabilities.
- Can be integrated with external software such as:
  - ServiceNow
  - Jira
  - PagerDuty
  - Slack

### Server Components

| Name                     | Description                                                                                                                                                                                                                                          |
| ------------------------ | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| Agent enrollment service | Enroll new agents. Provides and distributes unique auth keys to each agent. Process runs as network service and support auth via TLS/SSL cert or provide a fixed pass.                                                                               |
| Agent connection service | Receive data from the agents. Uses keys shared by the enrollment service to validate each agent identity and encrypt the communication between agent and server. Provides centralized config management, enabling pushing new agent remotely         |
| Analysis engine          | Perform data aalysis. Uses decoders to identify the type of information being processed.Decoders also extract relevant data elements from the log message. Using rules, the engine specific patterns in the decoded events that could trigger events |
| Wazuh RESTful API        | Provide interface to interct with Wazuh infra. Used to manage config settings of agents and servers, monitor the infra status and overall health, manage ad edit wazuh decoders and rules, and query about the state of the monitored endpoints      |
| Wazuh Cluster daemon     | Used to scale Wazuh servers horizontally, deploying as cluster. With this config + network load balancer, provides high availability and load balancing. This is what wazuh used to communicate with each other and keep sync                        |
| Filebeat                 | Used to send events and alerts to Wazuh Indexer. Read the output of theWazuh analysis engine and ships events in real time. Provides load balancing when connected to a multi-node Wazuh indexer cluster                                             |

## Wazuh dashboard

- Flexible and intuitive web user interface for `mining`, `analyzing`, and `visualizing security events and alerts data`.
- Used for management and monitoring of the Wazuh platform and provides features for role-based access control and single sign-on.

### Data visualization and analysis

- This web interface will helps you to navigate through different types of data collected, as well as the security alerts.
- You can also generate reports and create custom and create custom visualizations and dashboards.
- Wazuh provides OOTB dashboards for regulatory compliance such as:
  - PCI DSS
  - GDPR
  - HIPAA
  - NIST 800-53

![security information management](https://firebasestorage.googleapis.com/v0/b/test-agent-nwfy.appspot.com/o/security-information-management1.png?alt=media&token=763fabe6-bbea-47fd-95e8-b676d405ee31)
![threat detection and response](https://firebasestorage.googleapis.com/v0/b/test-agent-nwfy.appspot.com/o/threat-detection-and-response1.png?alt=media&token=f5bd8d2d-0dd8-4bb8-9fe4-46974db03101)
![policy monitoring](https://firebasestorage.googleapis.com/v0/b/test-agent-nwfy.appspot.com/o/policy-monitoring1.png?alt=media&token=3b577fb6-8dd8-4d3b-b9d6-aa359c2cadf6)
![dashboard regulatory compliance](https://firebasestorage.googleapis.com/v0/b/test-agent-nwfy.appspot.com/o/dashboard-regulatory-compliance1.png?alt=media&token=5da34bf9-fead-4a50-a792-d793a84d7271)

### Agents monitoring and configuration

- Allows users to manage agents configuration and to monitor their status.
- For each monitored endpoint, users can define `what agent modules will be enabled`, `what log files will be read`, `what files will be monitored for integrity changes`, or `what configuration checks will be performed`.

![agent monitoring](https://firebasestorage.googleapis.com/v0/b/test-agent-nwfy.appspot.com/o/agents-monitoring1.png?alt=media&token=bc1c5322-dbfc-4f91-98e1-3bb69c40aa2f)

### Platform management

- Provide a dedicated interface to manage wazuh deployment.
- Includes **monitoring the status**, **logs**, and **statistics**.
- Includes configuring the wazuh server, and creating custom rules and decoders for log analysis and threat detection.

![platform management](https://firebasestorage.googleapis.com/v0/b/test-agent-nwfy.appspot.com/o/platform-management1.png?alt=media&token=db9c5633-a54d-4ec9-ad2b-f4e5a5aa61bf)
![status and reports](https://firebasestorage.googleapis.com/v0/b/test-agent-nwfy.appspot.com/o/status-and-reports1.png?alt=media&token=7c3ad2cd-0abf-4082-b453-bb453962a0a6)

### Developer tools

- Includes a **_Ruleset Test tool_** that can process log messages to check how it is decoded and if it matches a threat detection rule or not.
- Useful when custom decoders and rules have been created and the user want to test them.

![ruleset test](https://firebasestorage.googleapis.com/v0/b/test-agent-nwfy.appspot.com/o/ruleset-test1.png?alt=media&token=2a68f86d-a443-4702-a310-9e96a3ea37b1)

- Also includes API console for users to interact with Wazuh API.
- Can be used to manage the Wazuh deployment.

![api console](https://firebasestorage.googleapis.com/v0/b/test-agent-nwfy.appspot.com/o/api-console1.png?alt=media&token=f2da51d3-5a05-45a7-af4e-28bbea1207f1)
![creating security rules](https://firebasestorage.googleapis.com/v0/b/test-agent-nwfy.appspot.com/o/creating-security-rules1.png?alt=media&token=41138e99-ef79-4d1d-8c5b-dcf715136f57)

## Wazuh agent

- It runs on **Linux**, **Windows**, **MacOS**, **Solaris**, **AIX**, and many more.
- Can be deploy on _laptops_, _desktops_, _server_, _cloud instances_, _containers_, or _virtual machines_.
- Helps to protect your system by providing `threat prevention`, `detection`, and `response capabilities`.
- Used to collect different types of system and application data that forwarded to wazuh server through an encrypted and authenticated channel.

### Agent architecture

- Has modular architecture.
- Each component is in charge of its own tasks, including:
  - **_monitoring the file system_**
  - **_reading log messages_**
  - **_collecting inventory data_**
  - **_scanning the system configuration_**
  - **_looking for malware_**
- User can manage agent modules via _configuration settings_, _adapting the solution to their particular use cases_.

![agent architecture](https://firebasestorage.googleapis.com/v0/b/test-agent-nwfy.appspot.com/o/agent-architecture1.png?alt=media&token=6267d85f-3bad-4231-bbb7-8fb8e51c774f)

### Agent modules

- All agent modules are configurable and perform different security task.

| Name                                   | Description                                                                                                                                                                                                                                                                                                                                                                   |
| -------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| Log collector                          | Read flat log files and Windows event, collectiong OS and Apps log messages. Support XPath filters for Windows events and recognizes multi-line formats like Linux Audit logs. Can also enrich JSON events with additional metadata.                                                                                                                                          |
| Command execution                      | Runs authorized commands periodically, collecting their output and reporting it back to Wazuh server for further analysis. Can use for different purpose( monitoring hard disk space left / Getting a list of the last logged-in users)                                                                                                                                       |
| File Integrity monitoring (FIM)        | Monitors the file system, reports when files are `created`, `deleted`, or `modified`. It keeps track of changes in `file attributes`, `permissions`, `ownership`, and `content` , and `content`. When an event hit, it captures `who, what, and when` in real time. Build and maintains a database with the state of the monitored files, allowing queries to be run remotely |
| Security configuration assessment(SCA) | Provides continuous config assessment, utilizing OOTB checks based on the Center of Internet Security (CIS) benchmarks. Can also create their own SCA checks to monitor and enforce their security policies                                                                                                                                                                   |
| Malware detection                      | Capable of detecting anomalies and possible presence of rootkits using a non-signature-based approach. Looks for hidden processes, hidden files, and hidden ports while monitoring system calls.                                                                                                                                                                              |
| Active response                        | Runs automatic actions when threats are detected, triggering responses to block a network connection, stop a running process, or delete a malicious file. Can also create a custom responses when necessary and customize.                                                                                                                                                    |
| Container security monitoring          | Integrated with the Docker Engine API to monitor changes in a containerized env.                                                                                                                                                                                                                                                                                              |
| Cloud security monitoring              | Monitor cloud providers such as Amazon AWS, Ms Azure, Google GCP. Communicate with it natively and capable of detecting any changes to the cloud infrastructure and collecting cloud services log data                                                                                                                                                                        |

### Communication with Wazuh server

- Wazuh agent communicate with wazuh server to ship collected data and security-related events.
- The agent send operational data, reporting its config and status.
- Once connected, agent can be `upgraded`, `monitored`, and `configured remotely` from the wazuh server
- Communication takes place through secure channel (TCP or UDP), providing data encryption and compression in real-time.
- Includes flow control mechanism to avoid **flooding**, **queueing events**, and **protecting network bandwidth**.
- `Agent needs to be enroll before connecting to the server for the first time`
